<div class="min-h-screen flex flex-col items-center justify-center p-4 text-slate-800">
  
  <!-- Header -->
  <header class="w-full max-w-4xl mx-auto mb-6">
    <div class="flex items-center space-x-3">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-600" viewBox="0 0 24 24" fill="currentColor">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/>
            <path d="M17.414 14L15.003 16.411 13.589 15l-2.015 2.015 1.414 1.414 2.015-2.015 2.411 2.411L19 17.414z"/>
        </svg>
        <div>
            <h1 class="text-3xl font-bold">PDF-Подпись</h1>
            <p class="text-slate-500">Подписывайте документы быстро и легко.</p>
        </div>
    </div>
  </header>

  <main class="w-full max-w-4xl mx-auto bg-white rounded-lg shadow-xl p-6">
    
    <!-- Step 1: File Upload -->
    @if (!pdfFile()) {
      <div class="text-center border-4 border-dashed border-slate-200 rounded-lg p-12 hover:border-blue-500 transition-colors">
        <svg class="mx-auto h-12 w-12 text-slate-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
          <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
        <h2 class="mt-4 text-xl font-semibold">Загрузите ваш PDF</h2>
        <p class="mt-1 text-sm text-slate-500">Выберите файл для подписи</p>
        <div class="mt-6">
          <label for="file-upload" class="cursor-pointer bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-all">
            <span>Выбрать PDF</span>
            <input id="file-upload" name="file-upload" type="file" class="sr-only" (change)="onFileSelected($event)" accept="application/pdf">
          </label>
        </div>
      </div>
    }

    <!-- Step 2: PDF Viewer and Signing Controls -->
    @if (pdfFile()) {
      <div>
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
            <div>
                <h3 class="text-lg font-semibold truncate">{{ fileName() }}</h3>
                <p class="text-sm text-slate-500">
                  @if (signatureDataUrl()) {
                    Нажмите, чтобы разместить подпись. Перетащите для перемещения или изменения размера.
                  } @else {
                    Сначала создайте или загрузите подпись.
                  }
                </p>
            </div>
            <div class="flex items-center flex-wrap gap-x-4 gap-y-2 flex-shrink-0">
                <!-- Pagination -->
                @if (totalPages() > 1) {
                  <div class="flex items-center space-x-2">
                      <button (click)="goToPreviousPage()" 
                              [disabled]="currentPage() === 1"
                              class="p-2 rounded-md hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                      </button>
                      <span class="text-sm font-medium text-slate-600 whitespace-nowrap">
                        {{ currentPage() }} / {{ totalPages() }}
                      </span>
                      <button (click)="goToNextPage()" 
                              [disabled]="currentPage() === totalPages()"
                              class="p-2 rounded-md hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                      </button>
                  </div>
                }
  
                <!-- Action Buttons -->
                <div class="flex items-center gap-2">
                    @if (!signatureDataUrl()) {
                        <button (click)="openSignatureModal()" class="bg-blue-600 text-white font-bold py-2 px-2 sm:px-4 rounded-lg hover:bg-blue-700 transition-all flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 12V7a2 2 0 012-2h2.586l-4 4H5z" clip-rule="evenodd" /><path d="M4 3a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2h-4v2a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2zm2 2v10h8V5H6z" /></svg>
                            <span class="hidden sm:inline sm:ml-2">Создать подпись</span>
                        </button>
                    }
                    @if (signatureDataUrl()) {
                        <button (click)="openSignatureModal()" class="bg-gray-200 text-gray-700 font-bold py-2 px-2 sm:px-4 rounded-lg hover:bg-gray-300 transition-all flex items-center">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M15.312 11.424a5.5 5.5 0 0 1-9.201 2.466l-.312-.311h2.433a.75.75 0 0 0 0-1.5H3.989a.75.75 0 0 0-.75.75v4.242a.75.75 0 0 0 1.5 0v-2.43l.31.31a7 7 0 0 0 11.712-3.138.75.75 0 0 0-1.449-.39Z" clip-rule="evenodd" />
                            <path fill-rule="evenodd" d="M4.688 8.576a5.5 5.5 0 0 1 9.201-2.466l.312.311V4.009a.75.75 0 0 0-1.5 0v2.432l-.31-.31a7 7 0 0 0-11.712 3.138.75.75 0 0 0 1.449.39Z" clip-rule="evenodd" />
                          </svg>
                          <span class="hidden sm:inline sm:ml-2">Изменить</span>
                        </button>
                        <button (click)="applyAndDownload()" 
                                [disabled]="placedSignatures().length === 0"
                                class="bg-green-600 text-white font-bold py-2 px-2 sm:px-4 rounded-lg hover:bg-green-700 transition-all flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            <span class="hidden sm:inline sm:ml-2">Применить и скачать</span>
                        </button>
                    }
                </div>
            </div>
        </div>

        <div id="pdf-viewer" 
             (click)="placeSignatureOnClick($event)"
             [class.cursor-copy]="!!signatureDataUrl()">
          
          @if (signatureDataUrl() && placedSignatures().length === 0) {
            <div class="absolute inset-0 bg-blue-500 bg-opacity-20 flex items-center justify-center z-10 pointer-events-none rounded-md border-2 border-dashed border-blue-600">
              <p class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg">Нажмите, чтобы разместить подпись</p>
            </div>
          }
          
          <canvas #pdfCanvas id="pdf-canvas" class="rounded-md shadow-md"></canvas>

          @for (sig of placedSignatures(); track sig.id) {
            @if (sig.page === currentPage()) {
              <div class="signature-wrapper"
                   [style.left.px]="sig.position.x"
                   [style.top.px]="sig.position.y"
                   [style.width.px]="sig.width"
                   [style.height.px]="sig.height"
                   (mousedown)="dragStart($event, sig)" 
                   (touchstart)="dragStart($event, sig)">
                
                <div (click)="deleteSignature(sig.id, $event)" class="delete-signature-btn" title="Удалить подпись">
                  &times;
                </div>
                
                <img [src]="signatureDataUrl()" 
                     alt="Signature"
                     class="w-full h-full">

                <div class="resize-handle"
                     (mousedown)="resizeStart($event, sig)"
                     (touchstart)="resizeStart($event, sig)"
                     title="Изменить размер подписи">
                </div>
              </div>
            }
          }
        </div>
      </div>
    }

  </main>

</div>

<!-- Signature Modal -->
@if (isSigning()) {
  <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl">
      <div class="p-6 border-b border-slate-200">
        <h3 class="text-xl font-bold">Ваша подпись</h3>
      </div>
      <div class="p-2 sm:p-4">
        <canvas #signatureCanvas class="w-full h-64 sm:h-96 border border-slate-300 rounded-md bg-white"></canvas>
      </div>
      <div class="p-4 flex flex-wrap justify-between items-center gap-4 bg-slate-50 rounded-b-lg">
        <div>
          <label for="signature-upload" class="cursor-pointer bg-white border border-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-100 transition-all flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor" fill="none" />
            </svg>
            <span>Загрузить</span>
          </label>
          <input id="signature-upload" type="file" class="sr-only" (change)="onSignatureImageSelected($event)" accept="image/png, image/jpeg, image/webp">
        </div>
        <div class="flex items-center space-x-3">
          <button (click)="clearSignature()" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300 transition-all">Очистить</button>
          <button (click)="closeSignatureModal()" class="bg-slate-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-600 transition-all">Отмена</button>
          <button (click)="saveSignature()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-all">Сохранить</button>
        </div>
      </div>
    </div>
  </div>
}

<!-- Cropping Modal -->
@if (isCropping()) {
  <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-2xl w-11/12 h-5/6 max-w-7xl flex flex-col">
      <div class="p-6 border-b border-slate-200">
        <h3 class="text-xl font-bold">Обрезать подпись</h3>
        <p class="text-sm text-slate-500">Выделите область с вашей подписью, чтобы убрать лишнее.</p>
      </div>
      <div class="p-2 sm:p-4 bg-slate-100 flex-grow flex justify-center items-center overflow-hidden">
        <canvas #croppingCanvas 
                class="max-w-full max-h-full border border-slate-300 rounded-md bg-white cursor-crosshair touch-none"
                (mousedown)="onCropMouseDown($event)"
                (mousemove)="onCropMouseMove($event)"
                (mouseup)="onCropMouseUp($event)"
                (mouseleave)="onCropMouseUp($event)"
                (touchstart)="onCropMouseDown($event)"
                (touchmove)="onCropMouseMove($event)"
                (touchend)="onCropMouseUp($event)">
        </canvas>
      </div>
      <div class="p-4 flex justify-end items-center gap-4 bg-slate-50 rounded-b-lg">
        <button (click)="cancelCrop()" class="bg-slate-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-600 transition-all">Отмена</button>
        <button (click)="applyCropAndSave()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-all">Обрезать и сохранить</button>
      </div>
    </div>
  </div>
}

<!-- Loading Overlay -->
@if (isLoading()) {
  <div class="fixed inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center z-50">
    <svg class="animate-spin h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <p class="mt-4 text-lg font-semibold">{{ loadingMessage() }}</p>
  </div>
}